<script>
/* ===== Modal ===== */
function showModal(msg){
  const modal = document.getElementById('modal');
  const modalMsg = document.getElementById('modalMsg');
  modalMsg.innerText = msg;
  modal.classList.remove('hidden');
}
function closeModal(){
  document.getElementById('modal').classList.add('hidden');
}
window.closeModal = closeModal;

/* ===== Main ===== */
document.addEventListener('DOMContentLoaded', () => {

  /* ---- DOM ---- */
  const calendarEl = document.getElementById('calendar');
  const btnGenerate = document.getElementById('btnGenerate');

  const examDateEl = document.getElementById('examDate');
  const subjectInputEl = document.getElementById('subjectInput');
  const weakSubjectEl = document.getElementById('weakSubject');
  const breakEveryEl = document.getElementById('breakEvery');
  const breakLengthEl = document.getElementById('breakLength');

  /* ---- Weekly time inputs ---- */
  const weekInputs = {
    0: { start: sunStart, end: sunEnd },
    1: { start: monStart, end: monEnd },
    2: { start: tueStart, end: tueEnd },
    3: { start: wedStart, end: wedEnd },
    4: { start: thuStart, end: thuEnd },
    5: { start: friStart, end: friEnd },
    6: { start: satStart, end: satEnd }
  };

  /* ---- Utils ---- */
  function getDateRange(start, end){
    const dates = [];
    let d = new Date(start);
    while(d <= end){
      dates.push(new Date(d));
      d.setDate(d.getDate() + 1);
    }
    return dates;
  }

  function getDailyMinutes(date){
    const input = weekInputs[date.getDay()];
    if(!input.start.value || !input.end.value) return 0;

    const [sh, sm] = input.start.value.split(':').map(Number);
    const [eh, em] = input.end.value.split(':').map(Number);

    return (eh * 60 + em) - (sh * 60 + sm);
  }

  /* ---- Generate Plan ---- */
  function generatePlan(){
    if(!examDateEl.value) return showModal('請輸入考試日期');
    if(!subjectInputEl.value) return showModal('請輸入科目');

    const examDate = new Date(examDateEl.value);
    examDate.setHours(0,0,0,0);

    const subjects = subjectInputEl.value
      .split(',')
      .map(s => s.trim())
      .filter(Boolean);

    const weakSubject = weakSubjectEl.value.trim();
    const breakEvery = Number(breakEveryEl.value) || 50;
    const breakLength = Number(breakLengthEl.value) || 10;

    const today = new Date();
    today.setHours(0,0,0,0);

    const days = getDateRange(today, examDate);
    const plan = [];

    let subjectIndex = 0;

    days.forEach(date => {
      let minutesLeft = getDailyMinutes(date);
      if(minutesLeft <= 0) return;

      const slots = [];
      while(minutesLeft > 0){
        const subject = subjects[subjectIndex % subjects.length];
        const studyTime =
          subject === weakSubject
            ? Math.min(breakEvery * 2, minutesLeft)
            : Math.min(breakEvery, minutesLeft);

        slots.push({ subject, minutes: studyTime });
        minutesLeft -= studyTime + breakLength;
        subjectIndex++;
      }

      plan.push({ date, slots });
    });

    renderCalendar(plan);
    showModal('讀書日程表已生成！');
  }

  /* ---- Render Calendar ---- */
  function renderCalendar(plan){
    calendarEl.innerHTML = '';
    const weekName = ['日','一','二','三','四','五','六'];

    plan.forEach(day => {
      const cell = document.createElement('div');
      cell.className = 'calendar-cell';

      const input = weekInputs[day.date.getDay()];
      let currentMinutes = 0;

      if(input.start.value){
        const [h,m] = input.start.value.split(':').map(Number);
        currentMinutes = h * 60 + m;
      }

      cell.innerHTML = `<b>${day.date.toISOString().split('T')[0]}（星期${weekName[day.date.getDay()]}）</b>`;

      day.slots.forEach(slot => {
        const startH = Math.floor(currentMinutes / 60);
        const startM = currentMinutes % 60;
        const end = currentMinutes + slot.minutes;
        const endH = Math.floor(end / 60);
        const endM = end % 60;

        const block = document.createElement('div');
        block.className = 'task-block';
        block.innerText =
          `${String(startH).padStart(2,'0')}:${String(startM).padStart(2,'0')}–` +
          `${String(endH).padStart(2,'0')}:${String(endM).padStart(2,'0')} ${slot.subject}`;

        cell.appendChild(block);
        currentMinutes = end + Number(breakLengthEl.value);
      });

      calendarEl.appendChild(cell);
    });
  }

  btnGenerate.addEventListener('click', generatePlan);
});
</script>
